<!DOCTYPE html> 
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pembayaran - NBB Coffee Hub</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    .font-title { font-family: 'Playfair Display', serif; }
    .font-body { font-family: 'Poppins', sans-serif; }
  </style>
</head>
<body class="font-body bg-gray-100">

  <!-- HEADER -->
  <header class="bg-[#4B3832]/90 text-[#EFEBE9] py-4 px-8">
     <img src="logo.png" alt="NBB Coffee Hub Logo" class="h-12 w-auto drop-shadow-md">
  </header>

  <!-- MAIN CONTENT -->
  <main class="max-w-5xl mx-auto bg-white rounded-lg shadow-lg p-8 mt-10 mb-20">
    <h2 class="text-3xl font-title text-[#4B3832] mb-8 text-center">Pembayaran Pesanan</h2>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

      <!-- DETAIL PEMBELIAN -->
      <section class="lg:col-span-2 space-y-6">
        <!-- Alamat Pengiriman -->
        <div class="border border-gray-200 rounded-lg p-5">
          <h3 class="font-semibold text-lg text-[#4B3832] mb-3">Alamat Pengiriman</h3>
          <p class="text-sm text-gray-700">Theodora Walukow</p>
          <p class="text-sm text-gray-700">Bandung, Jawa Barat</p>
          <p class="text-sm text-gray-700">Kode Pos: 0000 | No. Telp: +62000000</p>
          <button id="ubahAlamat" class="mt-3 text-[#B8860B] hover:underline text-sm">Ubah Alamat</button>
        </div>

        <!-- Detail Item (akan dirender lewat JS) -->
        <div id="detail-items-card" class="border border-gray-200 rounded-lg p-5">
          <h3 class="font-semibold text-lg text-[#4B3832] mb-4">Detail Item</h3>

          <div id="detail-items" class="space-y-4">
            <!-- item akan disisipkan di sini -->
          </div>
        </div>

        <!-- Metode Pengiriman -->
        <div class="border border-gray-200 rounded-lg p-5">
          <h3 class="font-semibold text-lg text-[#4B3832] mb-3">Metode Pengiriman</h3>
          <select id="metodePengiriman" class="w-full border border-gray-300 rounded-md px-3 py-2 focus:ring-[#B8860B] focus:border-[#B8860B]">
            <option value="">Pilih jasa pengiriman</option>
            <option value="jne">JNE Express</option>
            <option value="jnt">J&T Cargo</option>
            <option value="sicepat">SiCepat Reguler</option>
            <option value="anteraja">AnterAja</option>
          </select>
          <p class="text-sm text-gray-500 mt-2">*Waktu pengiriman tergantung daerah tujuan.</p>
        </div>

        <!-- Metode Pembayaran -->
        <div class="border border-gray-200 rounded-lg p-5">
          <h3 class="font-semibold text-lg text-[#4B3832] mb-3">Metode Pembayaran</h3>
          <div class="space-y-3">
            <label class="flex items-center gap-3">
              <input type="radio" name="metodeBayar" value="transfer" class="text-[#B8860B] focus:ring-[#B8860B]">
              <span>Transfer Bank (BCA, BNI, Mandiri)</span>
            </label>
            <label class="flex items-center gap-3">
              <input type="radio" name="metodeBayar" value="qris" class="text-[#B8860B] focus:ring-[#B8860B]">
              <span>QRIS / E-Wallet (GoPay, OVO, Dana, ShopeePay)</span>
            </label>
            <label class="flex items-center gap-3">
              <input type="radio" name="metodeBayar" value="virtual" class="text-[#B8860B] focus:ring-[#B8860B]">
              <span>Virtual Account (BCA VA, BNI VA, Mandiri VA)</span>
            </label>
          </div>
        </div>
      </section>

      <!-- RINGKASAN PESANAN -->
      <aside class="bg-[#FAF8F5] border border-gray-200 rounded-lg p-6 h-fit">
        <h3 class="font-semibold text-lg text-[#4B3832] mb-4">Ringkasan Pesanan</h3>

        <div class="space-y-2 text-sm">
          <div class="flex justify-between">
            <p>Subtotal</p>
            <p id="subtotal">Rp 0</p>
          </div>
          <div class="flex justify-between">
            <p>Biaya Pengiriman</p>
            <p id="ongkir">Rp 15.000</p>
          </div>
          <hr class="my-2">
          <div class="flex justify-between font-semibold text-[#4B3832] text-base">
            <p>Total Pembayaran</p>
            <p id="totalBayar">Rp 0</p>
          </div>
        </div>

        <div class="mt-6 flex flex-col gap-3">
          <button id="bayarBtn" class="bg-[#B8860B] text-white py-2 rounded-lg hover:bg-[#654321] transition">Bayar Sekarang</button>
          <button id="batalBtn" class="border border-[#B8860B] text-[#B8860B] py-2 rounded-lg hover:bg-[#B8860B] hover:text-white transition">Batal</button>
        </div>
      </aside>

    </div>
  </main>

  <!-- ✅ FOOTER -->
  <footer class="bg-[#4B3832]/90 text-[#EFEBE9] py-10 mt-12">
    <div class="text-center text-sm text-gray-300">&copy; 2025 NBB Coffee Hub Petani. All Rights Reserved.</div>
  </footer>

  <script>
    // Utility: format rupiah
    function formatRupiah(num) {
      if (!num && num !== 0) return "Rp 0";
      return "Rp " + Number(num).toLocaleString('id-ID');
    }

    // Ambil keranjang dari localStorage. Toleransi dua struktur: {nama,harga,jumlah} atau {name,price,quantity}
    let keranjang = JSON.parse(localStorage.getItem("keranjang")) || [];

    // Normalisasi item ke bentuk {name, price, quantity, img, penjual}
    function normalize(item) {
      return {
        name: item.nama || item.name || "Produk",
        price: (item.harga || item.price || 0),
        quantity: (item.jumlah || item.quantity || 1),
        img: item.img || item.gambar || null,
        penjual: item.penjual || item.seller || ""
      };
    }

    const detailContainer = document.getElementById("detail-items");
    const subtotalEl = document.getElementById("subtotal");
    const ongkirEl = document.getElementById("ongkir");
    const totalBayarEl = document.getElementById("totalBayar");
    const bayarBtn = document.getElementById("bayarBtn");
    const batalBtn = document.getElementById("batalBtn");
    const ubahAlamatBtn = document.getElementById("ubahAlamat");

    // Ongkir default (bisa hhitung dinamis nanti)
    const ONGKIR_DEFAULT = 15000;

    function renderDetailFromCart() {
      detailContainer.innerHTML = "";
      if (!keranjang || keranjang.length === 0) {
        detailContainer.innerHTML = `<p class="text-gray-500">Keranjang kosong. Silakan tambah produk terlebih dahulu.</p>`;
        subtotalEl.textContent = formatRupiah(0);
        ongkirEl.textContent = formatRupiah(ONGKIR_DEFAULT);
        totalBayarEl.textContent = formatRupiah(ONGKIR_DEFAULT);
        bayarBtn.disabled = true;
        bayarBtn.classList.add("opacity-60", "cursor-not-allowed");
        return;
      }

      let subtotal = 0;

      keranjang.forEach(raw => {
        const it = normalize(raw);
        const itemTotal = Number(it.price) * Number(it.quantity);
        subtotal += itemTotal;

        // HTML tampilan item (sesuai style)
        const itemHtml = document.createElement("div");
        itemHtml.className = "flex items-center justify-between border-b pb-3";

        itemHtml.innerHTML = `
          <div class="flex items-center gap-4">
            <img src="${it.img ? it.img : 'https://via.placeholder.com/80x80.png?text=Produk'}" class="w-16 h-16 object-cover rounded-md">
            <div>
              <p class="font-medium text-[#4B3832]">${escapeHtml(it.name)}</p>
              <p class="text-sm text-gray-500">${it.quantity} pcs ${it.penjual ? ' • '+escapeHtml(it.penjual) : ''}</p>
            </div>
          </div>
          <div class="text-right">
            <p class="font-medium text-[#654321]">${formatRupiah(itemTotal)}</p>
          </div>
        `;
        detailContainer.appendChild(itemHtml);
      });

      subtotalEl.textContent = formatRupiah(subtotal);
      ongkirEl.textContent = formatRupiah(ONGKIR_DEFAULT);
      totalBayarEl.textContent = formatRupiah(subtotal + ONGKIR_DEFAULT);

      // enable button
      bayarBtn.disabled = false;
      bayarBtn.classList.remove("opacity-60", "cursor-not-allowed");
    }

    // Escape HTML for safety in inserted strings
    function escapeHtml(unsafe) {
      return String(unsafe)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    // Bayar Sekarang: simpan pesanan, update akumulasi totalPembelian, kosongkan keranjang
    bayarBtn.addEventListener("click", () => {
      if (!keranjang || keranjang.length === 0) {
        alert("Keranjang kosong.");
        return;
      }

      // Hitung subtotal dari keranjang (again)
      let subtotal = keranjang.reduce((sum, raw) => {
        const it = normalize(raw);
        return sum + (Number(it.price) * Number(it.quantity));
      }, 0);

      const ongkir = ONGKIR_DEFAULT;
      const totalPembayaran = subtotal + ongkir;

      // 1) Update totalPembelian (akumulasi)
      let totalSebelumnya = parseInt(localStorage.getItem("totalPembelian")) || 0;
      let totalBaru = totalSebelumnya + totalPembayaran;
      localStorage.setItem("totalPembelian", totalBaru);

      // 2) Simpan pesanan ke pesananSelesai (array)
      let pesananSelesai = JSON.parse(localStorage.getItem("pesananSelesai")) || [];

      const now = new Date().toLocaleString("id-ID");
      // Simpan satu object pesanan berisi items, totals, tanggal
      const pesananObj = {
        id: Date.now(),
        tanggal: now,
        items: keranjang.map(raw => {
          const it = normalize(raw);
          return {
            namaProduk: it.name,
            jumlah: it.quantity,
            hargaSatuan: it.price,
            totalHarga: Number(it.price) * Number(it.quantity),
            img: it.img
          };
        }),
        subtotal: subtotal,
        ongkir: ongkir,
        total: totalPembayaran
      };

      pesananSelesai.push(pesananObj);
      localStorage.setItem("pesananSelesai", JSON.stringify(pesananSelesai));

      // 3) Kosongkan keranjang
      localStorage.removeItem("keranjang");
      localStorage.removeItem("totalKeranjang"); // jika ada

      // 4) Notifikasi & redirect
      alert("Pembayaran berhasil! Pesananmu masuk ke riwayat pesanan selesai.");
      // arahkan ke halaman Pesanan Saya / Riwayat
      window.location.href = "pembeli_pesanan.html";
    });

    // Tombol batal kembali ke keranjang
    batalBtn.addEventListener("click", () => {
      window.location.href = "pembeli_keranjang.html";
    });

    ubahAlamatBtn && ubahAlamatBtn.addEventListener("click", () => {
      window.location.href = "pembeli_editprofil.html";
    });

    // Render onload
    renderDetailFromCart();
  </script>
</body>
</html>